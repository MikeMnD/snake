<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <style>
    canvas {
        margin-left: 270px;
        position: absolute;
        border: 1px solid #000;
    }
    </style>
</head>

<body>
    <script>
    var COLS = 20,
        ROWS = 20,
        EMPTY = 0,
        SNAKE = 1,
        FRUIT = 2,
        LEFT = 0,
        UP = 1,
        RIGHT = 2,
        DOWN = 3,
        KEY_LEFT = 37,
        KEY_UP = 38,
        KEY_RIGHT = 39,
        KEY_DOWN = 40,
        canvas,
        ctx,
        keyState = {},
        frames = 0;

    var grid = {
        width: null,
        height: null,
        _grid: null,
        init: function(d, c, r) {
            this.width = c;
            this.height = r;
            this._grid = [];
            for (var x = 0; x < c; x++) {
                this._grid.push([]);
                for (var y = 0; y < r; y++) {
                    this._grid[x].push(d);
                }
            }
        },

        set: function(val, x, y) {
            this._grid[x][y] = val;
        },

        get: function(x, y) {
            return this._grid[x][y];
        }
    }

    var snake = {
        direction: null,
        first: null,
        _queue: null,

        init: function(d, x, y) {
            this.direction = d;
            this._queue = [];
            this.insert(x, y);
        },

        insert: function(x, y) {
            this._queue.unshift({
                x: x,
                y: y
            });
            this.first = this._queue[0];
        },

        remove: function() {
            return this._queue.pop();
        }
    };

    function setFood() {
        var empty = [];
        for (var i = 0; i < grid.width; i++) {
            for (var j = 0; j < grid.height; j++) {
                if (grid.get(i, j) === EMPTY) {
                    empty.push({
                        x: i,
                        y: j
                    });
                }
            }
        }

        var randPos = empty[Math.round(Math.random() * (empty.length - 1))];
        grid.set(FRUIT, randPos.x, randPos.y);
    }

    function main() {
        canvas = document.createElement("canvas");
        canvas.width = COLS * 20;
        canvas.height = ROWS * 20;

        ctx = canvas.getContext("2d");

        //zabravi da go append-nesh kum document.body!!!
        document.body.appendChild(canvas);

        document.addEventListener("keydown", function(evt) {
            keyState[evt.keyCode] = true;
        });

        document.addEventListener("keyup", function(evt) {
            delete keyState[evt.keyCode];
        });

        init();
        loop();
    }

    function init() {
        score = 0;
        grid.init(EMPTY, COLS, ROWS);
        var snakeCoords = {
            x: Math.floor(COLS / 2),
            y: ROWS - 1
        };
        snake.init(UP, snakeCoords.x, snakeCoords.y);
        grid.set(SNAKE, snakeCoords.x, snakeCoords.y);
        setFood();
    }

    function loop() {
        update();
        draw();
        window.requestAnimationFrame(loop, canvas);
    }

    function update() {
        frames++;
        //if we dont make these checks for direction snake can move directly from right to left, etc.
        if (keyState[KEY_LEFT] && snake.direction !== RIGHT) {
            snake.direction = LEFT;
        }
        if (keyState[KEY_UP] && snake.direction !== DOWN) {
            snake.direction = UP;
        }
        if (keyState[KEY_RIGHT] && snake.direction !== LEFT) {
            snake.direction = RIGHT;
        }
        if (keyState[KEY_DOWN] && snake.direction !== UP) {
            snake.direction = DOWN;
        }
        if (frames % 5 === 0) {
            var headX = snake.first.x;
            var headY = snake.first.y;
            switch (snake.direction) {
                case LEFT:
                    headX--;
                    break;
                case UP:
                    headY--;
                    break;
                case RIGHT:
                    headX++;
                    break;
                case DOWN:
                    headY++;
                    break;
            }
            if (0 > headX || headX > grid.width - 1 ||
                0 > headY || headY > grid.height - 1 ||
                grid.get(headX, headY) === SNAKE
            ) {
                var y = confirm("New Game?");
                if (y) {
                    return init();
                }
            }
            if (grid.get(headX, headY) === FRUIT) {
                setFood();
            } else {
                var tail = snake.remove();
                grid.set(EMPTY, tail.x, tail.y);
            }
            grid.set(SNAKE, headX, headY);
            snake.insert(headX, headY);
        }
    }


    function draw() {
        var tileWidth = canvas.width / grid.width;
        var tileHeight = canvas.height / grid.height;
        for (var x = 0; x < grid.width; x++) {
            for (var y = 0; y < grid.height; y++) {
                switch (grid.get(x, y)) {
                    case 0:
                        ctx.fillStyle = "orange";
                        break;
                    case 1:
                        ctx.fillStyle = "blue";
                        break;
                    case 2:
                        ctx.fillStyle = "green";
                        break;
                }
                ctx.fillRect(tileWidth * x, tileHeight * y, tileWidth, tileHeight);
            }
        }
    }

    //run the game
    main();
    </script>
</body>

</html>
